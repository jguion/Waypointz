<!DOCTYPE html>
<html>
	<head>
  	<title>Waypointz</title>
  	<meta name="viewport" content="width=device-width, initial-scale=1">
  	<style>
  		#map-canvas {
  			color:black;
        height: 100%;
        margin: 0px;
        padding: 0px;
        text-shadow: none;
      }
      .map_wrapper{
      	bottom: 30px;
      	left: 0px;
      	position: absolute;
      	right: 0;
      	top: 30px;
      }
  		[data-role=page]{
			height: 100% !important; 
			position:relative !important;
		}
		[data-role=footer]{
			bottom:0px; 
			position:absolute !important; 
			top: auto !important; 
			width:100%;
		} 
  	</style>
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places"></script>
  <script type="text/javascript">
  	var places = [];
  	var map;
  	var infoWindow;
  	var service;
  	var myLocation;
  	var searches = [];
  	var results = [];

		function initialize() {
		  var mapOptions = {
		    zoom: 9
		  };
		  map = new google.maps.Map(document.getElementById('map-canvas'),
		      mapOptions);

		  infoWindow = new google.maps.InfoWindow();

		  // Try HTML5 geolocation
		  if(navigator.geolocation) {
		    navigator.geolocation.getCurrentPosition(function(position) {
		      handleGeolocation(position);
		    }, function() {
		      handleNoGeolocation(true);
		    });
		  } else {
		    // Browser doesn't support Geolocation
		    handleNoGeolocation(false);
		  }



		  initialize_buttons();
		}

		function handleGeolocation(position){
			myLocation = new google.maps.LatLng(position.coords.latitude,
		                                   position.coords.longitude);
		  map.setCenter(myLocation);
		}

		function handleNoGeolocation(errorFlag) {
		  if (errorFlag) {
		    var content = 'Error: The Geolocation service failed. Please enable Geolocation';
		  } else {
		    var content = 'Error: Your browser doesn\'t support geolocation.';
		  }

		  var options = {
		    map: map,
		    position: new google.maps.LatLng(60, 105),
		    content: content
		  };

		  var infoWindow = new google.maps.InfoWindow(options);
		  map.setCenter(options.position);
		}



		//google.maps.event.addDomListener(window, 'load', initialize);

  	function initialize_buttons(){
  		$('#add_pt').click(function(){
  			$textbox = $('<input/>', {
  					'type':"text",
  					'data-clear-btn':"true"
  				});
  			$('#waypoints_list').append($('<li/>', {
  				'class':"ui-field-contain"
  				}).append($textbox));
  			$('#waypoints_list').listview('refresh');
  			$('#waypoints_list').trigger('create');
  		});

  		$("#find_places").submit(function( event ) {
  			places = [];
  			searches = [];
  			$("#waypoints_list").find('input[type=text]').each(function() {
  				places.push($(this).val());
  				service = new google.maps.places.PlacesService(map);
  				var radius = $("#radius").val() * 1609.34;
  				var request = {
  						location : myLocation,
  						radius : radius,
  						keyword : $(this).val(),
  				}
  				service.nearbySearch(request, callback);
  			});
  			event.preventDefault();
  		});
  	}

  function callback(results, status) {
  	if (status == google.maps.places.PlacesServiceStatus.OK) {
    	for (var i = 0; i < results.length; i++) {
      	var place = results[i];
      	console.log(place);
      	searches.push(place);
      	createMarker(place);
    	}
  	}
  }

  function createMarker(place) {
	  var marker = new google.maps.Marker({
	    map: map,
	    position: place.geometry.location,
	    icon: {
	      // Star
	      path: 'M 0,-24 6,-7 24,-7 10,4 15,21 0,11 -15,21 -10,4 -24,-7 -6,-7 z',
	      fillColor: '#ffff00',
	      fillOpacity: 1,
	      scale: 1/4,
	      strokeColor: '#bd8d2c',
	      strokeWeight: 1
	    }
	  });
	  google.maps.event.addListener(marker, 'click', function() {
	    service.getDetails(place, function(result, status) {
	      if (status != google.maps.places.PlacesServiceStatus.OK) {
	        alert(status);
	        return;
	      }
	      infoWindow.setContent(result.name);
	      infoWindow.open(map, marker);
	    });
	  });
	}
  </script>
  </head>
  <body onload="initialize()" class="ui-mobile-viewpoint">
  	<div data-role="page" id="pageone" data-theme="b">
	  	<div data-role="header">
	    	<h1>Waypointz</h1>
	    	<a href="#pagethree" class="settings_btn" id="settings">Settings</a>
	      <a href="#pagetwo" class="map_btn">Map View</a>
	  	</div>
	  	<div role="main" class="ui-content">
	  		<p>Welcome to Waypointz! Enter one or more places you would like to find:</p>
	  		<form id="find_places">
	  			<ul id="waypoints_list" data-role="listview" data-inset="true">
	  				<li class="ui-field-contain">
	  					<input type="text" data-clear-btn="true">
	  				</li>
	  			</ul>
	  			<input id="add_pt" type="button" data-icon="plus" value="Add Place">
					<button id="search" type="submit" class="ui-btn ui-corner-all ui-btn-a">Search</button>
				</form>
	  	</div>
			<div data-role="footer">
				<h1>GUI-on</h1>
			</div>
		</div>
		<div data-role="page" id="pagetwo" data-theme="b">
			<div data-role="header">
	    	<h1>Waypointz</h1>
	    	<a href="#pagethree" class="settings_btn" id="settings">Settings</a>
	      <a href="#pageone" class="map_btn">List View</a>
	  	</div>
			<div role="main" class="ui-content map_wrapper">
				<div id="map-canvas"></div>
			</div>
	  	<div data-role="footer">
				<h1>GUI-on</h1>
			</div>
		</div>
		<div data-role="page" id="pagethree" data-theme="b">
			<div data-role="header">
	    	<h1>Waypointz</h1>
	    	<a href="#pageone" class="list_btn" id="settings">List View</a>
	      <a href="#pagetwo" class="map_btn">Map View</a>
	  	</div>
			<div role="main" class="ui-content">
				<form id="settings">
	  			<ul id="settings_list" data-role="listview" data-inset="true">
	  				<li class="ui-field-contain">
	  					<label for="max_distance_settings">Distance radius (Miles)<label>
	  					<input id="radius" type="text" data-clear-btn="true" value="25">
	  				</li>
	  			</ul>
					<button id="save_settings" type="submit" class="ui-btn ui-corner-all ui-btn-a">Save</button>
			</div>
	  	<div data-role="footer">
				<h1>GUI-on</h1>
			</div>
		</div>


  </body>
</html>

